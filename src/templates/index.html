<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jazz Streams</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { padding-bottom: 100px; }
    .station { cursor: pointer; display:flex; align-items:center; gap:10px; padding:10px; border-bottom:1px solid #ddd; border-radius:5px; }
    .station img { border-radius: 50%; width: 50px; height: 50px; object-fit: cover; }
    .station .title { font-weight: bold; font-size: 1rem; }
    .station .meta { font-size: 0.85rem; color: #555; }
    .star { font-size: 1.8rem; color: #ccc; cursor: pointer; transition: color 0.2s; }
    .star.favorited { color: gold; }
    #nowPlayingBar { 
        position: fixed; bottom: 0; left: 0; right: 0; 
        background: #f8f9fa; border-top: 1px solid #ddd; 
        padding: 10px; display: flex; align-items:center; justify-content: space-between; 
    }
    #spinner { display:none; margin-left:10px; }
</style>
</head>
<body>

<nav class="navbar navbar-light bg-light mb-3">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Jazz Streams</span>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#favoritesModal">
            Favorites ⭐
        </button>
    </div>
</nav>

<div class="container">
    {% for s in stations %}
    <div class="station" data-uuid="{{ s.stationuuid }}" onclick="playStation('{{ s.stationuuid }}')">
        <img src="{{ s.favicon if s.favicon else url_for('static', filename='radio.png') }}" 
             alt="favicon" onerror="this.src='{{ url_for('static', filename='radio.png') }}'">
        <div class="flex-grow-1">
            <div class="title">{{ s.name }}</div>
            <div class="meta">Tags: {% for tag in s.tags.split(',')[:3] %}{{ tag }}{% if not loop.last %}, {% endif %}{% endfor %} • Bitrate: {{ s.bitrate }} kbps • Country: {{ s.country[:10] }}</div>
        </div>
        <span class="star" onclick="toggleFavorite(event, '{{ s.stationuuid }}')">☆</span>
    </div>
    {% endfor %}

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-3">
            {% if page > 1 %}
            <li class="page-item"><a class="page-link" href="/?page={{ page - 1 }}">Prev</a></li>
            {% endif %}
            {% if page < total_pages %}
            <li class="page-item"><a class="page-link" href="/?page={{ page + 1 }}">Next</a></li>
            {% endif %}
        </ul>
    </nav>
</div>

<!-- Now Playing Bar -->
<div id="nowPlayingBar">
    <div id="nowPlayingText">Not Playing</div>
    <div id="spinner" class="spinner-border spinner-border-sm text-primary" role="status"></div>
</div>

<!-- Favorites Modal -->
<div class="modal fade" id="favoritesModal" tabindex="-1" aria-labelledby="favoritesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="favoritesModalLabel">Favorites</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="favoritesList">
        Loading...
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let favorites = [];

// Play station and show spinner
function playStation(uuid) {
    const spinner = document.getElementById('spinner');
    spinner.style.display = 'inline-block';
    fetch(`/play/${uuid}`)
        .then(res => {
            spinner.style.display = 'none';
            if(res.ok) {
                const el = document.querySelector(`[data-uuid='${uuid}'] .title`);
                document.getElementById('nowPlayingText').textContent = 'Now Playing: ' + el.textContent;
            }
        })
        .catch(() => { spinner.style.display='none'; });
}

// toggle favorite
function toggleFavorite(event, uuid) {
    event.stopPropagation();
    fetch(`/favorite/${uuid}`, { method: 'POST' })
        .then(res => loadFavorites());
}

// Load favorites from server and render
function loadFavorites() {
    fetch('/favorites')
        .then(res => res.json())
        .then(data => {
            favorites = data.map(s => s.stationuuid);
            const container = document.getElementById('favoritesList');
            container.innerHTML = '';
            data.forEach(s => {
                const div = document.createElement('div');
                div.className = 'station mb-2 p-2 border rounded d-flex align-items-center gap-3';
                div.onclick = () => playStation(s.stationuuid);

                const img = document.createElement('img');
                img.src = s.favicon || '/static/radio.png';
                img.width = 50; img.height = 50;
                img.onerror = () => { img.src='/static/radio.png'; }
                div.appendChild(img);

                const info = document.createElement('div');
                info.className = 'flex-grow-1';
                info.innerHTML = `<div class="title">${s.name}</div>
                                  <div class="meta">Tags: ${s.tags.slice(0, 10)} • Bitrate: ${s.bitrate} kbps • Country: ${s.country.slice(0, 10)}</div>`;
                div.appendChild(info);

                const star = document.createElement('span');
                star.className = 'star favorited';
                star.textContent = '★';
                star.onclick = (e) => { e.stopPropagation(); toggleFavorite(e, s.stationuuid); }
                div.appendChild(star);

                container.appendChild(div);
            });

            // Update stars on main list
            document.querySelectorAll('.station').forEach(el => {
                const uuid = el.getAttribute('data-uuid');
                const star = el.querySelector('.star');
                if(favorites.includes(uuid)) star.classList.add('favorited'); 
                else star.classList.remove('favorited');
            });
        });
}

// Initial load
document.addEventListener('DOMContentLoaded', loadFavorites);
</script>

</body>
</html>
